(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{Yj9t:function(e,t,i){"use strict";i.r(t),i.d(t,"AuthModule",(function(){return F}));var r=i("sEIs"),a=i("42YS"),s=i("EM62");let n=(()=>{class e{constructor(){}ngOnInit(){}}return e.\u0275fac=function(t){return new(t||e)},e.\u0275cmp=s.Jb({type:e,selectors:[["app-auth"]],decls:0,vars:0,template:function(e,t){},encapsulation:2}),e})(),o=(()=>{class e{constructor(){}ngOnInit(){}}return e.\u0275fac=function(t){return new(t||e)},e.\u0275cmp=s.Jb({type:e,selectors:[["exchange-auth-standard-rp"]],decls:0,vars:0,template:function(e,t){},encapsulation:2}),e})();var c=i("47ST"),h=i("ROBh"),p=i("ke9K"),u=i("5uDM"),d=i("8j5Y"),l=i("4e/d"),b=i("q6bj"),S=i("pJFc"),g=i("vIZi");let v=(()=>{class e{constructor(e,t,i,r,a,s,n,o,c){this.authQuery=e,this.rpStateService=t,this.rpStateQuery=i,this.flowService=r,this.idpStateService=a,this.idpStateQuery=s,this.authNavigation=n,this.isamApiService=o,this.exchangeApi=c}resolve(){return this.authQuery.isAuthenticatedSso?this.initiateSsoFlow():this.idpStateQuery.rememberedIdpId?this.initiateRegularSessionFlowWithRememberedIdp():this.initiateRegularSessionFlow()}initiateRegularSessionFlow(){return this.establishExchangeConnection("authentication").pipe(Object(u.a)(()=>{var e;if(null===(e=this.rpStateQuery.response)||void 0===e?void 0:e.rpId)return this.getRelyingPartyInfo(this.rpStateQuery.response.rpId.toString())}),Object(u.a)(()=>this.checkForAttributeProviderSelection()),Object(d.a)(()=>{this.navigate(b.a.StandardRpAuthorisation)}))}initiateRegularSessionFlowWithRememberedIdp(){return this.establishExchangeConnection("authentication").pipe(Object(u.a)(()=>{var e;if(null===(e=this.rpStateQuery.response)||void 0===e?void 0:e.rpId)return this.getRelyingPartyInfo(this.rpStateQuery.response.rpId.toString())}),Object(u.a)(()=>this.getIdpInfo(this.idpStateQuery.rememberedIdpId)),Object(u.a)(()=>this.checkForAttributeProviderSelection()),Object(d.a)(()=>{this.flowService.updateIdp("selection",S.k.NotRequired),this.flowService.updateIdp("login",S.k.Required),this.navigate(b.a.StandardRpAuthorisation)}))}initiateSsoFlow(){return this.getRelyingPartyInfo(this.rpStateQuery.info.id).pipe(Object(u.a)(()=>this.getIdpInfo(this.idpStateQuery.getActiveId())),Object(u.a)(()=>this.checkForAttributeProviderSelection()),Object(d.a)(()=>{this.flowService.updateIdp("selection",S.k.NotRequired),this.flowService.updateIdp("login",S.k.NotRequired),this.navigate(b.a.StandardRpAuthorisation)}),Object(l.a)(e=>(console.error(e),Object(c.a)(e))))}navigate(e){this.authNavigation.resolveNavigation(e)}establishExchangeConnection(e){return this.isamApiService.sendAuthInformation(e,this.rpStateQuery.authId,this.rpStateQuery.request).pipe(Object(d.a)(e=>{this.rpStateService.updateRelyingPartyResponseParams(e)}))}getIdpInfo(e){return this.exchangeApi.retrieveSpecificIdentityProvider(String(e)).pipe(Object(d.a)(e=>{this.idpStateService.addSingleIdentityProvider(e),this.idpStateService.setActiveIdentityProvider(e.id)}))}checkForAttributeProviderSelection(){return this.rpStateQuery.hasScope("tdif_business_authorisations")?(this.flowService.updateAp("selection",S.k.Required),Object(h.a)(!0)):Object(h.a)(!1)}getRelyingPartyInfo(e){return this.rpStateService.beginLoading(),this.exchangeApi.getRelyingPartyInfo(e).pipe(Object(d.a)(e=>{this.rpStateService.updateRelyingPartyInfo(e),this.rpStateService.completeLoading()}))}}return e.\u0275fac=function(t){return new(t||e)(s.Zb(a.b),s.Zb(p.l),s.Zb(p.k),s.Zb(b.f),s.Zb(p.h),s.Zb(p.g),s.Zb(b.b),s.Zb(g.d),s.Zb(g.a))},e.\u0275prov=s.Lb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})();var I=i("3s82"),y=i("fN3Q"),f=i("81ol");let m=(()=>{class e{constructor(e,t,i,r,a,s,n,o,c,h,p){this.storageService=e,this.router=t,this.rpStateService=i,this.rpStateQuery=r,this.authPersistedQuery=a,this.authPersistedService=s,this.idpStateService=n,this.configQuery=o,this.authService=c,this.isamApiService=h,this.flowService=p}resolve(){return this.flowService.resetStore(),this.rpStateService.updateRelyingPartyAuthId(Object(y.v4)()),this.configQuery.featureFlags["remember-idp-storage"]?this.checkForRememberIdpSelection():this.checkForRememberIdpCookie(),this.authPersistedQuery.isAuthenticatedSso&&this.configQuery.featureFlags.sso?this.rpStateQuery.isIntegrationFlow?this.initiateIntegrationSsoSessionFlowRedirect():this.initiateSsoSessionFlowRedirect():this.rpStateQuery.isIntegrationFlow?this.initiateRegularSessionIntegrationFlowRedirect():this.initiateRegularSessionFlowRedirect()}initiateRegularSessionFlowRedirect(){return this.createSession().pipe(Object(d.a)(()=>{this.redirectToStandardAuth()}))}initiateRegularSessionIntegrationFlowRedirect(){return this.createSession().pipe(Object(d.a)(()=>{this.redirectToLinkableAuth()}))}initiateSsoSessionFlowRedirect(){return this.createSsoSession().pipe(Object(u.a)(e=>(this.updateSsoInfo(e.body),Object(h.a)(e.body))),Object(d.a)(e=>{e&&this.redirectToStandardAuth()}),Object(l.a)(()=>Object(h.a)(null)))}initiateIntegrationSsoSessionFlowRedirect(){return this.createSsoSession().pipe(Object(u.a)(e=>(this.updateSsoInfo(e.body),Object(h.a)(e.body))),Object(d.a)(()=>{this.redirectToLinkableAuth()}))}redirectToLinkableAuth(){this.router.navigate(["authorise","linkable-rp"],{replaceUrl:!0})}redirectToStandardAuth(){this.router.navigate(["authorise","standard-rp"],{replaceUrl:!0})}updateSsoInfo(e){this.rpStateService.updateRelyingPartyInfo({id:e.rpId}),this.idpStateService.setActiveIdentityProvider(Number(e.idpId)),this.idpStateService.updateIdpAuthId(e.idpAuthId)}createSession(){return this.authService.setSessionId(Object(y.v4)()),this.isamApiService.getInitialToken()}createSsoSession(){return this.isamApiService.reestablishSsoSession({rpAuthId:this.rpStateQuery.authId,rpParams:this.rpStateQuery.request}).pipe(Object(l.a)(()=>Object(h.a)(null)))}checkForRememberIdpCookie(){if(this.storageService.getCookie("rememberIdpCookie")){const e=Number(this.storageService.getCookie("rememberIdpCookie"));this.idpStateService.setRememberedIdentityProvider(e)}}checkForRememberIdpSelection(){if(this.authPersistedQuery.hasRememberedIdp){const e=Date.now();new Date(e)>this.authPersistedQuery.rememberedIdpExpiryDate?this.authPersistedService.unsetRememberIdp():this.idpStateService.setRememberedIdentityProvider(this.authPersistedQuery.rememberedIdpId)}}}return e.\u0275fac=function(t){return new(t||e)(s.Zb(I.a),s.Zb(r.e),s.Zb(p.l),s.Zb(p.k),s.Zb(a.b),s.Zb(a.c),s.Zb(p.h),s.Zb(f.b),s.Zb(a.d),s.Zb(g.d),s.Zb(b.f))},e.\u0275prov=s.Lb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})(),k=(()=>{class e{constructor(){}ngOnInit(){}}return e.\u0275fac=function(t){return new(t||e)},e.\u0275cmp=s.Jb({type:e,selectors:[["exchange-auth-linkable-rp"]],decls:0,vars:0,template:function(e,t){},encapsulation:2}),e})();var R=i("vobO");let j=(()=>{class e{constructor(e,t,i,r,a,s,n,o,c,h,p,u,d){this.authQuery=e,this.idpStateQuery=t,this.rpStateQuery=i,this.rpStateService=r,this.linkableIdpStateQuery=a,this.linkableIdpStateService=s,this.idpStateService=n,this.flowService=o,this.authNavigation=c,this.configQuery=h,this.isamApi=p,this.integrationApi=u,this.exchangeApi=d}resolve(){return this.authQuery.isAuthenticatedSso?this.initiateLinkableSsoSessionFlow():this.idpStateQuery.rememberedIdpId?this.initiateLinkableSessionFlowWithRememberedIdp():this.initiateLinkableRegularSessionFlow()}initiateLinkableRegularSessionFlow(){return this.establishExchangeConnection("authentication").pipe(Object(u.a)(()=>this.getLinkableRpInfo()),Object(u.a)(()=>this.getRelyingPartyInfo(this.rpStateQuery.response.rpId.toString())),Object(u.a)(()=>this.configQuery.featureFlags.enable_AP_selection?this.checkForAttributeProviderSelection():Object(h.a)(null)),Object(d.a)(()=>{this.flowService.updateIntegration("login",S.k.Required),this.flowService.updateIntegration("consent",S.k.Required),this.navigate(b.a.LinkableRpAuthorisation)}))}initiateLinkableSessionFlowWithRememberedIdp(){return this.establishExchangeConnection("authentication").pipe(Object(u.a)(()=>this.getLinkableRpInfo()),Object(u.a)(()=>this.getRelyingPartyInfo(this.rpStateQuery.response.rpId.toString())),Object(u.a)(()=>this.getIdpInfo(this.idpStateQuery.rememberedIdpId)),Object(u.a)(()=>this.configQuery.featureFlags.enable_AP_selection?this.checkForAttributeProviderSelection():Object(h.a)(null)),Object(d.a)(()=>{this.flowService.updateIdp("selection",S.k.NotRequired),this.flowService.updateIdp("login",S.k.Required),this.flowService.updateIntegration("login",S.k.Required),this.flowService.updateIntegration("consent",S.k.Required),this.navigate(b.a.LinkableRpAuthorisation)}))}initiateLinkableSsoSessionFlow(){return this.getRelyingPartyInfo(this.rpStateQuery.info.id).pipe(Object(u.a)(()=>this.getIdpInfo(this.idpStateQuery.getActiveId())),Object(u.a)(()=>this.getLinkableRpInfo()),Object(u.a)(()=>this.getSsoProgress()),Object(u.a)(()=>this.configQuery.featureFlags.enable_AP_selection?this.checkForAttributeProviderSelection():Object(h.a)(null)),Object(d.a)(()=>{switch(this.flowService.updateIdp("selection",S.k.NotRequired),this.flowService.updateIdp("login",S.k.NotRequired),this.linkableIdpStateQuery.connectorType){case S.e.Connect:this.flowService.updateIntegration("login",S.k.Required);break;default:this.flowService.updateIntegration("login",S.k.NotRequired)}this.flowService.updateIntegration("consent",S.k.Required),this.navigate(b.a.LinkableRpAuthorisation)}))}checkForAttributeProviderSelection(){return this.rpStateQuery.hasScope("tdif_business_authorisations")?(this.flowService.updateAp("selection",S.k.Required),Object(h.a)(!0)):Object(h.a)(!1)}establishExchangeConnection(e){return this.isamApi.sendAuthInformation(e,this.rpStateQuery.authId,this.rpStateQuery.request).pipe(Object(d.a)(e=>{this.rpStateService.updateRelyingPartyResponseParams(e)}))}getLinkableRpInfo(){const e=(new R.e).set("triggerClaim","mygov_linked");return this.integrationApi.getLinkableDetails(e).pipe(Object(d.a)(e=>{this.linkableIdpStateService.updateLinkableRelyingPartyInfo(e[0])}))}getRelyingPartyInfo(e){return this.exchangeApi.getRelyingPartyInfo(e).pipe(Object(d.a)(e=>{this.rpStateService.updateRelyingPartyInfo(e),this.rpStateService.completeLoading()}))}getIdpInfo(e){return this.exchangeApi.retrieveSpecificIdentityProvider(String(e)).pipe(Object(d.a)(e=>{this.idpStateService.addSingleIdentityProvider(e),this.idpStateService.setActiveIdentityProvider(e.id)}))}generateLinkRpAuthId(){this.linkableIdpStateQuery.rpAuthId||this.linkableIdpStateService.updateLinkableRPAuthId(Object(y.v4)())}getSsoProgress(){const e=(new R.e).set("idpAuthId",this.idpStateQuery.authId).set("linkIdpId",this.linkableIdpStateQuery.linkableId.toString());return this.integrationApi.getLinkableUserProgress(this.rpStateQuery.authId,e).pipe(Object(d.a)(e=>{this.linkableIdpStateService.updateLinkProgress(e)}))}navigate(e){this.authNavigation.resolveNavigation(e)}}return e.\u0275fac=function(t){return new(t||e)(s.Zb(a.b),s.Zb(p.g),s.Zb(p.k),s.Zb(p.l),s.Zb(p.i),s.Zb(p.j),s.Zb(p.h),s.Zb(b.f),s.Zb(b.b),s.Zb(f.b),s.Zb(g.d),s.Zb(g.c),s.Zb(g.a))},e.\u0275prov=s.Lb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})(),O=(()=>{class e{constructor(){}}return e.\u0275fac=function(t){return new(t||e)},e.\u0275cmp=s.Jb({type:e,selectors:[["exchange-auth-stepup"]],decls:2,vars:0,template:function(e,t){1&e&&(s.Vb(0,"p"),s.Gc(1,"hey this works"),s.Ub())},styles:[""]}),e})();var w=i("HM3f"),A=i("xVbo"),Q=i("xoJQ");const P=[{path:"",component:n,resolve:{authorised:m},pathMatch:"full"},{path:"standard-rp",component:o,resolve:{standard:v},pathMatch:"full"},{path:"linkable-rp",component:k,resolve:{linkable:j},pathMatch:"full"},{path:"step-up",component:O,canActivate:[a.e],resolve:{stepup:(()=>{class e{constructor(e,t,i,r,a,s,n,o,c){this.navigation=e,this.flowService=t,this.idpQuery=i,this.storage=r,this.config=a,this.isamApi=s,this.timeoutQuery=n,this.timeoutStateService=o,this.authPersistedStateService=c}resolve(){return this.authoriseStepUp(this.idpQuery.nonce).pipe(Object(u.a)(()=>this.config.featureFlags["remember-idp-storage"]?this.setRememberIdp():this.setRememberIdpCookie()),Object(u.a)(()=>this.updateLoginState()),Object(u.a)(()=>this.restartTimeout()),Object(d.a)(([e,t])=>{this.restartTimers(e,t),this.navigate(b.a.StepUp)}))}restartTimers(e,t){this.timeoutQuery.activityTimeoutIsActivated||(this.timeoutStateService.cancelActivityTimer(),this.timeoutStateService.cancelWarningTimer(),this.timeoutStateService.startActivityWarningTimer(t),this.timeoutStateService.startActivityTimer(e))}authoriseStepUp(e){return this.isamApi.getEscalatedToken(e)}addDays(e,t){return e.setDate(e.getDate()+t),e}setRememberIdp(){return this.idpQuery.rememberedIdpId?this.config.configuration$.pipe(Object(A.a)(e=>null!==e["remember-idp.cookie.expiry"]),Object(d.a)(e=>{const t=e["remember-idp.cookie.expiry"];this.authPersistedStateService.updateRememberIdp(this.addDays(new Date,t),this.idpQuery.rememberedIdpId)})):Object(h.a)(!1)}setRememberIdpCookie(){return this.idpQuery.rememberedIdpId?this.config.configuration$.pipe(Object(A.a)(e=>null!==e["remember-idp.cookie.expiry"]),Object(d.a)(e=>{this.storage.setCookie("rememberIdpCookie",this.idpQuery.rememberedIdpId,86400*e["remember-idp.cookie.expiry"])})):Object(h.a)(!1)}updateLoginState(){return this.flowService.updateIdp("login",S.k.Completed),Object(h.a)(!0)}restartTimeout(){return Object(w.a)([this.timeoutQuery.activityExpiry,this.timeoutQuery.activityWarning])}navigate(e){this.navigation.resolveNavigation(e)}}return e.\u0275fac=function(t){return new(t||e)(s.Zb(b.p),s.Zb(b.f),s.Zb(p.g),s.Zb(I.a),s.Zb(f.b),s.Zb(g.d),s.Zb(Q.b),s.Zb(Q.c),s.Zb(a.c))},e.\u0275prov=s.Lb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})()},pathMatch:"full"}];let Z=(()=>{class e{}return e.\u0275mod=s.Nb({type:e}),e.\u0275inj=s.Mb({factory:function(t){return new(t||e)},imports:[[r.g.forChild(P)],r.g]}),e})(),F=(()=>{class e{}return e.\u0275mod=s.Nb({type:e}),e.\u0275inj=s.Mb({factory:function(t){return new(t||e)},providers:[],imports:[[Z]]}),e})()}}]);